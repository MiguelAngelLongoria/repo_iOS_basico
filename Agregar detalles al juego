// Clase base de personaje
class Personaje {
    var nombre: String
    var lugar_actual: UbicacionFisica?

    init(nombre: String) {
        self.nombre = nombre
    }
}

// Enum de roles dentro del juego
enum RolesJuegoEscondidas {
    case contando
    case buscando_jugadores
    case buscando_escondite
    case escondido
    case regresando_a_base
    case encontrado
    case cantar_victoria
    case suspendido
}

// Protocolo que define un jugador de escondidas
protocol JugadorDeEscondidas {
    var rol: RolesJuegoEscondidas { get set }
    func actualizar() -> Bool
}

// Clase que implementa un personaje jugable
class PersonajeJugable: Personaje, JugadorDeEscondidas {
    var rol: RolesJuegoEscondidas = .suspendido
    var compañeros_de_juego: [PersonajeJugable] = []
    var visibilidad: Double = 0.5

    func actualizar() -> Bool {
        switch(rol) {
            case .escondido:
                /// Si está escondido en el Ropero_para_Narnia, no sale del closet por su papa
                if let lugar = lugar_actual, lugar.nombre == "Ropero_para_Narnia" { // narnia
                    let probabilidad_moverse = Int.random(in: 0...20)
                    if probabilidad_moverse == 0 { // Muy baja probabilidad de moverse desde Narnia // narnia
                        self.moverse_de_lugar()
                    }
                }
            default:
                break
        }
        return true
    }

    func moverse_de_lugar() {
        print("\(nombre) se movió de lugar")
    }

    func identificar_jugadores() {
        for compañero in compañeros_de_juego {
            if compañero.lugar_actual!.nombre == self.lugar_actual!.nombre {
                var probabilidad_omitir = Int(compañero.visibilidad * 100)

                /// Si el compañero está en el Ropero_para_Narnia, que ya salga del closet
                if compañero.lugar_actual?.nombre == "Ropero_para_Narnia" { // narnia
                    probabilidad_omitir += 30 // Aumenta la dificultad para encontrar // narnia
                }

                let suerte = Int.random(in: 0...100)

                if suerte > probabilidad_omitir {
                    compañero.rol = .encontrado
                    print("¡\(nombre) encontró a \(compañero.nombre) en \(lugar_actual?.nombre ?? "algún lugar")!")
                }
            }
        }
    }
}

// Clase de ubicaciones físicas
class UbicacionFisica {
    var nombre: String
    var conexiones: [UbicacionFisica] = []

    init(_ nombre: String) {
        self.nombre = nombre
    }

    func agregar_lugar(_ lugar: UbicacionFisica) {
        conexiones.append(lugar)
    }
}

// CREACIÓN DE LUGARES
let sala_de_estar = UbicacionFisica("Sala_de_estar")
let salon = UbicacionFisica("Salon")

///  Ropero_para_Narnia aquí nadie me encontrara
let ropero_narnia = UbicacionFisica("Ropero_para_Narnia") // narnia

/// El ropero de Narnia está conectado a la sala de estar y al salón
sala_de_estar.agregar_lugar(ropero_narnia) // narnia
salon.agregar_lugar(ropero_narnia) // narnia
